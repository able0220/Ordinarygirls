import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import warnings
import os
%matplotlib inline
warnings.filterwarnings('ignore')
plt.rcParams['font.family'] = 'NanumGothic'
import seaborn as sns


from google.colab import files
apple = files.upload()

import csv
f= open('AAPL.csv', encoding = 'euc-kr')
data = pd.read_csv(f)

data.dropna()


# 날짜를 인덱스로 설정하고 'Close' 가격만 사용
data['Date'] = pd.to_datetime(data['Date'])
data.set_index('Date', inplace=True)
stock_prices = data['Close'].values.reshape(-1, 1)

print(stock_prices)


from sklearn.preprocessing import MinMaxScaler
scaler = MinMaxScaler(feature_range=(0, 1))
stock_prices_scaled = scaler.fit_transform(stock_prices)



def create_sequences(data, sequence_length):
    x, y = [], []
    for i in range(len(data) - sequence_length - 1):
        x.append(data[i:(i + sequence_length), 0])
        y.append(data[i + sequence_length, 0])
    return np.array(x), np.array(y)

sequence_length = 50
x, y = create_sequences(stock_prices_scaled, sequence_length)
x = np.reshape(x, (x.shape[0], x.shape[1], 1))  # LSTM에 맞게 데이터 차원 변경



split = int(0.8 * len(x))
x_train, x_test = x[:split], x[split:]
y_train, y_test = y[:split], y[split:]


from tensorflow.keras.models import Sequential
from tenso성
# 'High'와 'Close' 선택 및 스케일링
features = data[['High', 'Close']]
scaler = MinMaxScaler(feature_range=(0, 1))
features_scaled = scaler.fit_transform(features)


def create_sequences(features, sequence_length):
    x, y = [], []
    for i in range(len(features) - sequence_length - 1):
        x.append(features[i:(i + sequence_length)])
        y.append(features[i + sequence_length, 1])  # 'Close' 가격을 예측 대상으로 설정
    return np.array(x), np.array(y)

sequence_length = 50
x, y = create_sequences(features_scaled, sequence_length)



split = int(0.8 * len(x))
x_train, x_test = x[:split], x[split:]
y_train, y_test = y[:split], y[split:]


model = Sequential([
    LSTM(50, return_sequences=True, input_shape=(sequence_length, 2)),  # 입력 차원을 2로 설정
    Dropout(0.2),
    LSTM(50),
    Dropout(0.2),
    Dense(1)
])
model.compile(optimizer='adam', loss='mean_squared_error')


predicted_stock_price = model.predict(x_test)
predicted_stock_price = scaler.inverse_transform(np.concatenate((np.zeros_like(predicted_stock_price), predicted_stock_price), axis=1))[:,1]  # 스케일 역변환
real_stock_price = scaler.inverse_transform(np.concatenate((np.zeros_like(y_test.reshape(-1, 1)), y_test.reshape(-1, 1)), axis=1))[:,1]

plt.plot(real_stock_price, color='red', label='Real Apple Stock Price')
plt.plot(predicted_stock_price, color='blue', label='Predicted Apple Stock Price')
plt.title('Apple Stock Price Prediction')
plt.xlabel('Time')
plt.ylabel('Price')
plt.legend()
plt.show()

# 모델 훈련
model.fit(x_train, y_train, epochs=30, batch_size=32)
